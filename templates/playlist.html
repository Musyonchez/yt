{% extends "base.html" %}

{% block title %}Playlist - YouTube Audio Downloader{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Playlist header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Import Playlist</h1>
                <p class="text-gray-600">Import videos from YouTube playlists</p>
            </div>
        </div>
        
        <!-- Playlist URL form -->
        <form id="playlist-form" class="flex space-x-3">
            <div class="flex-1">
                <input type="url" 
                       id="playlist-input" 
                       placeholder="https://www.youtube.com/playlist?list=..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                       value="{{ request.args.get('url', '') }}">
            </div>
            <button type="submit" 
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center">
                <i class="fas fa-list mr-2"></i>Load Playlist
            </button>
        </form>
        
        <!-- Help text -->
        <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex items-start space-x-2">
                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                <div class="text-sm text-blue-700">
                    <p class="font-medium mb-1">How to get a playlist URL:</p>
                    <ol class="list-decimal list-inside space-y-1 text-blue-600">
                        <li>Go to the YouTube playlist you want to import</li>
                        <li>Copy the URL from your browser's address bar</li>
                        <li>Paste it in the field above and click "Load Playlist"</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading state -->
    <div id="loading-state" class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200 hidden">
        <div class="spinner w-8 h-8 border-2 border-gray-300 border-t-green-600 rounded-full mx-auto mb-4"></div>
        <p class="text-gray-600">Loading playlist videos...</p>
        <p class="text-sm text-gray-500 mt-2">This may take a moment for large playlists</p>
    </div>
    
    <!-- Empty state -->
    <div id="empty-state" class="text-center py-16 bg-white rounded-lg shadow-sm border border-gray-200">
        <i class="fas fa-list text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Import a Playlist</h3>
        <p class="text-gray-600 max-w-md mx-auto mb-6">
            Enter a YouTube playlist URL above to view all videos and select which ones to download.
        </p>
        <div class="flex flex-wrap justify-center gap-2 text-sm">
            <span class="text-gray-500">Example playlist types:</span>
            <span class="bg-gray-100 px-3 py-1 rounded-full text-gray-700">Music Albums</span>
            <span class="bg-gray-100 px-3 py-1 rounded-full text-gray-700">Podcasts</span>
            <span class="bg-gray-100 px-3 py-1 rounded-full text-gray-700">Audio Books</span>
        </div>
    </div>
    
    <!-- Playlist results -->
    <div id="playlist-results" class="hidden space-y-4">
        <!-- Playlist info -->
        <div id="playlist-info" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <h3 id="playlist-title" class="text-lg font-semibold text-gray-900 mb-1">Playlist Title</h3>
                        <p id="playlist-video-count" class="text-gray-600">0 videos</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-3">
                    <button id="select-all-videos" class="text-sm text-green-600 hover:text-green-800 font-medium">
                        Select All
                    </button>
                    <button id="add-selected-videos" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Add Selected (<span id="selected-video-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filter controls -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">Filter:</label>
                    <select id="duration-filter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">All Durations</option>
                        <option value="short">Short (< 4 min)</option>
                        <option value="medium">Medium (4-20 min)</option>
                        <option value="long">Long (> 20 min)</option>
                    </select>
                    <input type="text" 
                           id="title-filter" 
                           placeholder="Filter by title..." 
                           class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <span>Showing:</span>
                    <span id="visible-count" class="font-medium">0</span>
                    <span>of</span>
                    <span id="total-count" class="font-medium">0</span>
                    <span>videos</span>
                </div>
            </div>
        </div>
        
        <!-- Videos grid -->
        <div id="videos-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Videos will be populated here -->
        </div>
        
        <!-- Load more button -->
        <div class="text-center">
            <button id="load-more-videos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors hidden">
                <i class="fas fa-chevron-down mr-2"></i>Load More Videos
            </button>
        </div>
    </div>
    
    <!-- Error state -->
    <div id="error-state" class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200 hidden">
        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Playlist</h3>
        <p id="error-message" class="text-gray-600 mb-4">Unable to load the playlist. Please check the URL and try again.</p>
        <button id="retry-playlist" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-redo mr-2"></i>Try Again
        </button>
    </div>
</div>

<!-- Video item template -->
<template id="playlist-video-template">
    <div class="playlist-video bg-white rounded-lg shadow-sm border border-gray-200 hover-lift transition-all duration-200">
        <div class="relative">
            <img class="video-thumbnail w-full h-32 object-cover rounded-t-lg" src="" alt="Video thumbnail">
            <div class="video-duration absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded"></div>
            <div class="video-select absolute top-2 left-2">
                <input type="checkbox" class="w-4 h-4 text-green-600 bg-white border-2 border-white rounded focus:ring-green-500 focus:ring-2">
            </div>
            <div class="video-status absolute top-2 right-2 hidden">
                <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                    <i class="fas fa-check mr-1"></i>Added
                </span>
            </div>
        </div>
        <div class="p-3">
            <h4 class="video-title font-medium text-gray-900 text-sm mb-1 line-clamp-2" title=""></h4>
            <p class="video-channel text-gray-600 text-xs mb-2"></p>
            <div class="flex items-center justify-between">
                <button class="add-single bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-medium transition-colors flex items-center">
                    <i class="fas fa-plus mr-1"></i>Add
                </button>
                <div class="flex items-center space-x-2">
                    <button class="preview-btn text-gray-600 hover:text-gray-800 text-xs" title="Preview on YouTube">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <span class="video-index text-xs text-gray-500">#1</span>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize playlist functionality
    const Playlist = {
        currentPlaylistData: null,
        selectedVideos: new Set(),
        visibleVideos: [],
        displayedCount: 0,
        videosPerLoad: 20,
        
        init: function() {
            this.bindEvents();
            
            // Auto-load if URL parameter is present
            const urlParams = new URLSearchParams(window.location.search);
            const playlistUrl = urlParams.get('url');
            if (playlistUrl) {
                this.loadPlaylist(playlistUrl);
            }
        },
        
        bindEvents: function() {
            // Playlist form submission
            const playlistForm = document.getElementById('playlist-form');
            if (playlistForm) {
                playlistForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const url = document.getElementById('playlist-input').value.trim();
                    if (url) {
                        this.loadPlaylist(url);
                    }
                });
            }
            
            // Bulk selection controls
            document.getElementById('select-all-videos')?.addEventListener('click', () => this.toggleSelectAll());
            document.getElementById('add-selected-videos')?.addEventListener('click', () => this.addSelected());
            
            // Filter controls
            document.getElementById('duration-filter')?.addEventListener('change', () => this.applyFilters());
            document.getElementById('title-filter')?.addEventListener('input', () => this.applyFilters());
            
            // Load more button
            document.getElementById('load-more-videos')?.addEventListener('click', () => this.loadMoreVideos());
            
            // Retry button
            document.getElementById('retry-playlist')?.addEventListener('click', () => {
                const url = document.getElementById('playlist-input').value.trim();
                if (url) this.loadPlaylist(url);
            });
        },
        
        loadPlaylist: async function(url) {
            try {
                this.showLoadingState();
                
                const response = await fetch(`/api/playlist?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load playlist');
                }
                
                this.currentPlaylistData = data.videos || [];
                this.displayPlaylist();
                
            } catch (error) {
                console.error('Error loading playlist:', error);
                this.showErrorState(error.message);
                App.showToast('Error loading playlist: ' + error.message, 'error');
            }
        },
        
        displayPlaylist: function() {
            if (!this.currentPlaylistData || this.currentPlaylistData.length === 0) {
                this.showErrorState('No videos found in playlist');
                return;
            }
            
            // Update playlist info
            document.getElementById('playlist-title').textContent = 'Playlist Videos';
            document.getElementById('playlist-video-count').textContent = `${this.currentPlaylistData.length} videos`;
            
            // Reset state
            this.selectedVideos.clear();
            this.visibleVideos = [...this.currentPlaylistData];
            this.displayedCount = 0;
            
            // Show results container
            this.showResultsState();
            
            // Load initial videos
            this.loadMoreVideos();
            
            // Update filter counts
            this.updateFilterCounts();
        },
        
        loadMoreVideos: function() {
            const videosGrid = document.getElementById('videos-grid');
            const loadMoreBtn = document.getElementById('load-more-videos');
            const template = document.getElementById('playlist-video-template');
            
            const endIndex = Math.min(this.displayedCount + this.videosPerLoad, this.visibleVideos.length);
            
            for (let i = this.displayedCount; i < endIndex; i++) {
                const video = this.visibleVideos[i];
                const videoElement = this.createVideoElement(video, template, i + 1);
                videosGrid.appendChild(videoElement);
            }
            
            this.displayedCount = endIndex;
            
            // Show/hide load more button
            if (this.displayedCount >= this.visibleVideos.length) {
                loadMoreBtn.classList.add('hidden');
            } else {
                loadMoreBtn.classList.remove('hidden');
            }
        },
        
        createVideoElement: function(video, template, index) {
            const clone = template.content.cloneNode(true);
            const element = clone.querySelector('.playlist-video');
            
            // Set video data
            element.dataset.videoUrl = video.url;
            element.dataset.videoId = video.video_id;
            
            // Update content
            clone.querySelector('.video-thumbnail').src = video.thumbnail;
            clone.querySelector('.video-thumbnail').alt = video.title;
            clone.querySelector('.video-duration').textContent = video.duration;
            clone.querySelector('.video-title').textContent = video.title;
            clone.querySelector('.video-title').title = video.title;
            clone.querySelector('.video-channel').textContent = video.channel;
            clone.querySelector('.video-index').textContent = `#${index}`;
            
            // Bind events
            const checkbox = clone.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => this.toggleVideoSelection(video.url, checkbox.checked));
            
            const addBtn = clone.querySelector('.add-single');
            addBtn.addEventListener('click', () => this.addSingleVideo(video.url));
            
            const previewBtn = clone.querySelector('.preview-btn');
            previewBtn.addEventListener('click', () => window.open(video.url, '_blank'));
            
            return clone;
        },
        
        applyFilters: function() {
            const durationFilter = document.getElementById('duration-filter').value;
            const titleFilter = document.getElementById('title-filter').value.toLowerCase();
            
            this.visibleVideos = this.currentPlaylistData.filter(video => {
                // Duration filter
                if (durationFilter) {
                    const duration = this.parseDuration(video.duration);
                    if (durationFilter === 'short' && duration >= 240) return false;
                    if (durationFilter === 'medium' && (duration < 240 || duration > 1200)) return false;
                    if (durationFilter === 'long' && duration <= 1200) return false;
                }
                
                // Title filter
                if (titleFilter && !video.title.toLowerCase().includes(titleFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Reset display
            this.displayedCount = 0;
            document.getElementById('videos-grid').innerHTML = '';
            this.loadMoreVideos();
            this.updateFilterCounts();
        },
        
        parseDuration: function(durationStr) {
            const parts = durationStr.split(':').map(Number);
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1]; // MM:SS
            } else if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
            }
            return 0;
        },
        
        updateFilterCounts: function() {
            document.getElementById('visible-count').textContent = this.visibleVideos.length;
            document.getElementById('total-count').textContent = this.currentPlaylistData.length;
        },
        
        toggleVideoSelection: function(url, selected) {
            if (selected) {
                this.selectedVideos.add(url);
            } else {
                this.selectedVideos.delete(url);
            }
            this.updateSelectedCount();
        },
        
        toggleSelectAll: function() {
            const checkboxes = document.querySelectorAll('#videos-grid input[type="checkbox"]');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allSelected;
                const videoElement = checkbox.closest('.playlist-video');
                const url = videoElement.dataset.videoUrl;
                this.toggleVideoSelection(url, checkbox.checked);
            });
        },
        
        updateSelectedCount: function() {
            document.getElementById('selected-video-count').textContent = this.selectedVideos.size;
        },
        
        addSelected: async function() {
            if (this.selectedVideos.size === 0) {
                App.showToast('No videos selected', 'warning');
                return;
            }
            
            try {
                const urls = Array.from(this.selectedVideos);
                await App.addToQueue(urls);
                
                // Mark as added visually
                urls.forEach(url => {
                    const videoElement = document.querySelector(`[data-video-url="${url}"]`);
                    if (videoElement) {
                        const statusElement = videoElement.querySelector('.video-status');
                        statusElement.classList.remove('hidden');
                        const checkbox = videoElement.querySelector('input[type="checkbox"]');
                        checkbox.checked = false;
                    }
                });
                
                this.selectedVideos.clear();
                this.updateSelectedCount();
                
                App.showToast(`Added ${urls.length} videos to queue`, 'success');
                
            } catch (error) {
                App.showToast('Error adding videos to queue: ' + error.message, 'error');
            }
        },
        
        addSingleVideo: async function(url) {
            try {
                await App.addToQueue([url]);
                
                // Mark as added visually
                const videoElement = document.querySelector(`[data-video-url="${url}"]`);
                if (videoElement) {
                    const statusElement = videoElement.querySelector('.video-status');
                    statusElement.classList.remove('hidden');
                }
                
                App.showToast('Added to queue', 'success');
                
            } catch (error) {
                App.showToast('Error adding to queue: ' + error.message, 'error');
            }
        },
        
        showLoadingState: function() {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('playlist-results').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
        },
        
        showResultsState: function() {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('playlist-results').classList.remove('hidden');
        },
        
        showErrorState: function(message) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('playlist-results').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
    };
    
    // Initialize playlist functionality
    Playlist.init();
    
    // Make Playlist available globally
    window.Playlist = Playlist;
});
</script>
{% endblock %}