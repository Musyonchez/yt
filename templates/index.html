{% extends "base.html" %}

{% block title %}Dashboard - YouTube Audio Downloader{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h1>
                <p class="text-gray-600">Manage your YouTube audio downloads</p>
            </div>
            <div class="mt-4 md:mt-0">
                <div class="flex items-center space-x-4 text-sm text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-download text-green-500 mr-2"></i>
                        <span>{{ downloaded_count }} Downloaded</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock text-yellow-500 mr-2"></i>
                        <span>{{ queue_count }} In Queue</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- URL Input Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover-lift flex flex-col h-full">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-youtube/10 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-link text-youtube"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Quick Add</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4 flex-grow">Paste a YouTube URL to add it to your queue</p>
            
            <form id="quick-add-form" class="space-y-3 mt-auto">
                <div>
                    <input type="url" 
                           id="quick-url-input" 
                           placeholder="https://www.youtube.com/watch?v=..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-youtube focus:border-transparent text-sm"
                           required>
                </div>
                <button type="submit" 
                        class="w-full bg-youtube hover:bg-youtube-dark text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>Add to Queue
                </button>
            </form>
        </div>
        
        <!-- Search Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover-lift flex flex-col h-full">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-search text-blue-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Search YouTube</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4 flex-grow">Find videos by artist, song name, or keywords</p>
            
            <form id="quick-search-form" class="space-y-3 mt-auto">
                <div>
                    <input type="text" 
                           id="quick-search-input" 
                           placeholder="Search for music..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                           required>
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
            </form>
        </div>
        
        <!-- Playlist Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover-lift flex flex-col h-full">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-list text-green-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Playlist Import</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4 flex-grow">Import entire YouTube playlists at once</p>
            
            <form id="quick-playlist-form" class="space-y-3 mt-auto">
                <div>
                    <input type="url" 
                           id="quick-playlist-input" 
                           placeholder="Playlist URL..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                           required>
                </div>
                <button type="submit" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-list mr-2"></i>Import Playlist
                </button>
            </form>
        </div>
    </div>
    
    <!-- Download Progress Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Download Progress</h3>
            <button id="clear-completed" 
                    class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
                <i class="fas fa-broom mr-1"></i>Clear Completed
            </button>
        </div>
        
        <!-- Progress container -->
        <div id="progress-container" class="space-y-3">
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-download text-4xl mb-3"></i>
                <p>No active downloads</p>
                <p class="text-sm">Add videos to your queue to start downloading</p>
            </div>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-green-600">{{ downloaded_count }}</div>
            <div class="text-sm text-gray-600">Downloaded</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-yellow-600">{{ queue_count }}</div>
            <div class="text-sm text-gray-600">In Queue</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 text-center">
            <div id="active-downloads" class="text-2xl font-bold text-blue-600">0</div>
            <div class="text-sm text-gray-600">Active</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 text-center">
            <div id="failed-downloads" class="text-2xl font-bold text-red-600">0</div>
            <div class="text-sm text-gray-600">Failed</div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
        <div id="recent-activity" class="space-y-3">
            <div class="text-center py-6 text-gray-500">
                <i class="fas fa-history text-3xl mb-2"></i>
                <p>No recent activity</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quick add form
    const quickAddForm = document.getElementById('quick-add-form');
    if (quickAddForm) {
        quickAddForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('quick-url-input').value.trim();
            if (url) {
                App.addToQueue([url]).then(() => {
                    document.getElementById('quick-url-input').value = '';
                    App.showToast('Added to queue successfully', 'success');
                }).catch(error => {
                    App.showToast('Error adding to queue: ' + error.message, 'error');
                });
            }
        });
    }
    
    // Quick search form
    const quickSearchForm = document.getElementById('quick-search-form');
    if (quickSearchForm) {
        quickSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = document.getElementById('quick-search-input').value.trim();
            if (query) {
                window.location.href = '/search?q=' + encodeURIComponent(query);
            }
        });
    }
    
    // Quick playlist form
    const quickPlaylistForm = document.getElementById('quick-playlist-form');
    if (quickPlaylistForm) {
        quickPlaylistForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('quick-playlist-input').value.trim();
            if (url) {
                window.location.href = '/playlist?url=' + encodeURIComponent(url);
            }
        });
    }
    
    // Clear completed button
    const clearCompletedBtn = document.getElementById('clear-completed');
    if (clearCompletedBtn) {
        clearCompletedBtn.addEventListener('click', function() {
            App.clearCompleted();
        });
    }
    
    // Initialize progress monitoring
    App.initializeProgressMonitoring();
    
    // Update dashboard stats periodically
    setInterval(() => {
        App.updateDashboardStats();
    }, 5000);
});

// Dashboard-specific functionality
const Dashboard = {
    updateStats: function(stats) {
        // Update statistics cards
        const activeDownloads = document.getElementById('active-downloads');
        const failedDownloads = document.getElementById('failed-downloads');
        
        if (activeDownloads) {
            activeDownloads.textContent = stats.downloading || 0;
        }
        
        if (failedDownloads) {
            failedDownloads.textContent = stats.failed || 0;
        }
    },
    
    updateProgress: function(progressData) {
        const container = document.getElementById('progress-container');
        if (!container) return;
        
        const activeDownloads = Object.values(progressData.active_downloads || {});
        
        if (activeDownloads.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-download text-4xl mb-3"></i>
                    <p>No active downloads</p>
                    <p class="text-sm">Add videos to your queue to start downloading</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        activeDownloads.forEach(download => {
            const statusColor = {
                'pending': 'bg-gray-200',
                'downloading': 'bg-blue-500',
                'completed': 'bg-green-500',
                'failed': 'bg-red-500'
            }[download.status] || 'bg-gray-200';
            
            const statusIcon = {
                'pending': 'fas fa-clock',
                'downloading': 'fas fa-download',
                'completed': 'fas fa-check',
                'failed': 'fas fa-exclamation-triangle'
            }[download.status] || 'fas fa-clock';
            
            html += `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <i class="${statusIcon} text-gray-600"></i>
                            <span class="font-medium text-gray-900 truncate max-w-xs">
                                ${download.filename || 'Unknown'}
                            </span>
                        </div>
                        <span class="text-sm text-gray-600 capitalize">${download.status}</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${statusColor} h-2 rounded-full progress-bar" 
                                 style="width: ${download.percentage || 0}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-600">
                        <span>${Math.round(download.percentage || 0)}%</span>
                        <span>${download.speed || ''}</span>
                        <span>${download.eta || ''}</span>
                    </div>
                    
                    ${download.error ? `
                        <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                            ${download.error}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    addRecentActivity: function(activity) {
        const container = document.getElementById('recent-activity');
        if (!container) return;
        
        // Clear "no activity" message if present
        if (container.querySelector('.text-center')) {
            container.innerHTML = '';
        }
        
        const activityItem = document.createElement('div');
        activityItem.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg fade-in';
        activityItem.innerHTML = `
            <i class="fas fa-${activity.icon} text-${activity.color}-500"></i>
            <div class="flex-1">
                <p class="text-sm text-gray-900">${activity.message}</p>
                <p class="text-xs text-gray-600">${activity.time}</p>
            </div>
        `;
        
        // Add to top of list
        container.insertBefore(activityItem, container.firstChild);
        
        // Keep only last 10 activities
        const activities = container.children;
        if (activities.length > 10) {
            container.removeChild(activities[activities.length - 1]);
        }
    }
};

// Make Dashboard available globally
window.Dashboard = Dashboard;
</script>
{% endblock %}